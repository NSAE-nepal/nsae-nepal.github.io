---
import { getCollection } from "astro:content";
import Badge from "../astro/Badge.astro";
import ArrowRight from "@tabler/icons/outline/arrow-right.svg";
const faqs = await getCollection("faq");
import Plus from "@tabler/icons/outline/plus.svg";
import Minus from "@tabler/icons/outline/minus.svg";
---

<section id="faq-section" class="py-24 md:py-32">
  <div class="flex flex-col gap-4 mb-12 header-content">
    <Badge
      variant="secondary"
      size="sm"
      class={"font-mono text-xs uppercase tracking-widest"}
    >
      FAQ
    </Badge>

    <h1
      class="font-sans text-4xl md:text-5xl font-medium tracking-tighter text-balance"
    >
      Frequently Asked Questions
    </h1>
  </div>

  {
    faqs.length > 0 ? (
      <div class="space-y-4 ">
        {faqs.map((faq) => (
          <details
            class="group rounded-xl bg-secondary/50 border border-border/50 p-6 [&_summary::-webkit-details-marker]:hidden overflow-hidden"
            name="faq-accordion"
          >
            <summary class="flex cursor-pointer items-center justify-between gap-4 text-lg font-sans font-medium text-foreground marker:content-none hover:text-primary transition-colors select-none">
              <span>{faq.data.question}</span>

              <span class="relative flex size-8 shrink-0 items-center justify-center rounded-full border border-border bg-background transition-colors group-hover:border-primary/50">
                {/* Note: We handle rotation in GSAP now, but keeping classes for fallback */}
                <div class="icon-container relative size-4">
                  <Plus class="absolute inset-0 size-4 transition-opacity duration-300 icon-plus" />
                  <Minus class="absolute inset-0 size-4 opacity-0 transition-opacity duration-300 icon-minus" />
                </div>
              </span>
            </summary>

            <div class="faq-content font-sans text-muted-foreground leading-relaxed border-t border-border/50 mt-4 pt-4">
              <div class="overflow-hidden">{faq.data.answer}</div>
            </div>
          </details>
        ))}
      </div>
    ) : (
      <div class="text-center p-12 font-sans text-muted-foreground">
        <p>No questions currently available.</p>
      </div>
    )
  }

  <div class="mt-12 flex flex-col items-center gap-3 text-center cta-content">
    <p class="font-sans text-lg text-muted-foreground text-balance">
      Need a personalized answer?
    </p>
    <a
      href="/contact"
      class="inline-flex items-center gap-2 font-mono text-xs uppercase tracking-widest text-primary hover:text-primary/80 transition-colors"
    >
      Contact our team <ArrowRight class="size-4" />
    </a>
  </div>
</section>

<style>
  .faq-content {
    height: 0;
    opacity: 0;
    overflow: hidden;
    will-change: height, opacity;
  }

  .icon-plus,
  .icon-minus {
    transform-origin: center;
  }
</style>

<script>
  import gsap from "gsap";

  if (typeof window !== "undefined") {
    const detailsElements = document.querySelectorAll("#faq-section details");

    detailsElements.forEach((detail) => {
      const summary = detail.querySelector("summary");
      const content = detail.querySelector(".faq-content");
      const plusIcon = detail.querySelector(".icon-plus");
      const minusIcon = detail.querySelector(".icon-minus");
      const iconContainer = detail.querySelector(".icon-container");

      if (summary && content) {
        summary.addEventListener("click", (e) => {
          e.preventDefault();

          const isOpen = detail.hasAttribute("open");

          if (!isOpen) {
            detailsElements.forEach((otherDetail) => {
              if (otherDetail !== detail && otherDetail.hasAttribute("open")) {
                const otherContent = otherDetail.querySelector(".faq-content");
                const otherPlus = otherDetail.querySelector(".icon-plus");
                const otherMinus = otherDetail.querySelector(".icon-minus");
                const otherIconContainer =
                  otherDetail.querySelector(".icon-container");

                gsap.to(otherContent, {
                  height: 0,
                  opacity: 0,
                  duration: 0.3,
                  ease: "power2.in",
                  onComplete: () => otherDetail.removeAttribute("open"),
                });
                gsap.to(otherIconContainer, { rotation: 0, duration: 0.3 });
                gsap.to(otherPlus, { opacity: 1, duration: 0.3 });
                gsap.to(otherMinus, { opacity: 0, duration: 0.3 });
              }
            });
          }

          if (isOpen) {
            gsap.to(content, {
              height: 0,
              opacity: 0,
              duration: 0.3,
              ease: "power2.in",
              onComplete: () => detail.removeAttribute("open"),
            });

            gsap.to(iconContainer, { rotation: 0, duration: 0.3 });
            gsap.to(plusIcon, { opacity: 1, duration: 0.3 });
            gsap.to(minusIcon, { opacity: 0, duration: 0.3 });
          } else {
            detail.setAttribute("open", "true");

            gsap.fromTo(
              content,
              { height: 0, opacity: 0 },
              {
                height: "auto",
                opacity: 1,
                duration: 0.5,
                ease: "power2.out",
              }
            );

            gsap.to(iconContainer, { rotation: 180, duration: 0.5 });
            gsap.to(plusIcon, { opacity: 0, duration: 0.3 });
            gsap.to(minusIcon, { opacity: 1, duration: 0.3 });
          }
        });
      }
    });
  }
</script>
